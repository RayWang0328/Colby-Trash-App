<!DOCTYPE html>
<html>

<head>
  <title>Image Annotation App</title>
  <style>
    .loader {
      border: 16px solid #f3f3f3;
      /* Light grey */
      border-top: 16px solid #3498db;
      /* Blue */
      border-radius: 50%;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
      display: none;
      margin-top: 20px;
      margin-bottom: 10px;
      /* Hidden by default */
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <nav>
    <a href="./">Home</a>
    <a href="./csv/">CSV</a>
    <a href="./overlap/">Overlap</a>
    <a href="./map/">Map</a>
    <a href="./plots/">Plot</a>
  </nav>

  <h1>Image Annotation App</h1>

  <input type="file" id="image-selector" multiple>
  <button id="submit-button">Submit</button>
  <button id="clear-button">Clear Results</button>

  <div style="margin: 10px 0;"></div>

  <!-- Add the loader here -->
  <div class="loader" id="loader"></div>
  <!-- Add status text here -->
  <div id="loading-status"></div>

  <div id="results"></div>


  <script>
    const submitButton = document.getElementById('submit-button');
    const resultsDiv = document.getElementById('results');
    const loader = document.getElementById('loader');
    const loadingStatus = document.getElementById('loading-status');

    submitButton.addEventListener('click', () => {
      const imageInput = document.getElementById('image-selector');
      const formData = new FormData();

      let totalFiles = imageInput.files.length;
      if (totalFiles === 0) {
        return;
      }

      // Show loader
      loader.style.display = 'block';
      loadingStatus.textContent = `Processing ${totalFiles} Image(s)`;

      for (let i = 0; i < totalFiles; i++) {
        formData.append('img_directory', imageInput.files[i]);
      }

      fetch('/process_images', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          // Hide loader
          loader.style.display = 'none';

          resultsDiv.innerHTML = ''; // clear previous results

          data.predicted_classes.forEach((row, i) => {
            const div = document.createElement('div');
            div.style.display = 'flex'; // Set div as a flex container
            div.style.alignItems = 'center'; // Vertically center the contents
            div.style.marginBottom = '10px'; // Add space between divs

            const img = document.createElement('img');
            img.src = 'data:image/jpg;base64,' + data.crops[i];
            img.width = 100;
            img.style.marginRight = '10px'; // Add space to the right of the image

            const p = document.createElement('p');
            p.textContent = row[0] + ', ' + row[1] + ', ' + row[2];
            p.style.marginRight = '10px'; // Add space to the right of the paragraph

            const actionDiv = document.createElement('div');
            actionDiv.style.display = 'flex'; // Set actionDiv as a flex container
            actionDiv.style.justifyContent = 'center'; // Horizontally center the contents

            const select = document.createElement('select');
            select.style.marginRight = '10px'; // Add space to the right of the select
            const classes = ['plastic', 'cage', 'wood', 'fishing gear', 'nature', 'metal', 'wheel']; // List of classes
            classes.forEach((cls) => {
              const option = document.createElement('option');
              option.text = cls;
              option.value = cls;
              if (cls === row[2]) { option.selected = true; }
              select.appendChild(option);
            });

            const button = document.createElement('button');
            button.textContent = 'Finalize Changes';
            button.addEventListener('click', () => {
              fetch(`/update_class?index=${i}&new_class=${select.value}`)
                .then(response => response.json())
                .then(data => {
                  // Do something with the data
                  console.log(data);
                })
            });

            // Add the select and button to the actionDiv
            actionDiv.appendChild(select);
            actionDiv.appendChild(button);

            // Add the elements to the div
            div.appendChild(p);
            div.appendChild(img);
            div.appendChild(actionDiv);

            resultsDiv.appendChild(div);

          });

          // Clear status text when all done
          loadingStatus.textContent = '';
        })
        .catch(error => {
          // Hide loader in case of error
          loader.style.display = 'none';
          // Clear status text in case of error
          loadingStatus.textContent = '';
        });
    });




    const clearButton = document.getElementById('clear-button');

    // Add click handler
    clearButton.addEventListener('click', () => {

      fetch('/clear_results')
        .then(response => {
          // Handle response
        })
        .catch(error => {
          // Handle error
        });

    });

  </script>

</body>

</html>